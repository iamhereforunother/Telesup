<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>s</title>

  <!-- Fonts (optional, –∫–æ–ø–∏—Ä—É–π –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@900&family=Inter:wght@700;900&family=Manrope:wght@700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0B0D0F;
      --text:#f7f7f7;
      --accent:#6fb3ff;
      --muted:rgba(255,255,255,0.58);
      --control-height:72px;
      --toolbar-height:64px;
      --panel-height:0px;
      --glass-bg: rgba(255,255,255,0.06);
      --glass-border: rgba(255,255,255,0.09);
      --glass-shadow: 0 10px 36px rgba(0,0,0,0.5);
      --btn-size:52px;
      --btn-radius:12px;
      --transition-fast: 220ms cubic-bezier(.2,.9,.2,1);
      --transition-slow: 420ms cubic-bezier(.2,.9,.2,1);
      --range-thumb-gray: #bdbdbd;
      --range-thumb-border-dark: rgba(0,0,0,0.35);
      --range-thumb-border-light: rgba(255,255,255,0.9);
    }

    /* THEMES */
    :root[data-theme='dark']{
      --bg:#0B0D0F; --text:#f7f7f7; --accent:#6fb3ff; --muted:rgba(255,255,255,0.58);
      --glass-bg: rgba(255,255,255,0.06); --glass-border: rgba(255,255,255,0.09);
    }
    :root[data-theme='light']{
      --bg:#f7f7f8; --text:#0b0b0b; --accent:#0055aa; --muted:rgba(0,0,0,0.6);
      --glass-bg: rgba(255,255,255,0.7); --glass-border: rgba(0,0,0,0.06);
    }
    :root[data-theme='sepia']{
      --bg:#f4ecd8; --text:#2b230f; --accent:#6b4d1e; --muted:rgba(0,0,0,0.5);
      --glass-bg: rgba(255,255,255,0.7); --glass-border: rgba(0,0,0,0.04);
    }
    :root[data-theme='navy']{
      --bg:#0F1C39; --text:#e4e4e4; --accent:#6fb3ff; --muted:rgba(255,255,255,0.7);
      --glass-bg: rgba(255,255,255,0.03); --glass-border: rgba(255,255,255,0.06);
    }
    :root[data-theme='contrast']{
      --bg:#000; --text:#fff; --accent:#ffd400; --muted:rgba(255,255,255,0.9);
      --glass-bg: rgba(255,255,255,0.04); --glass-border: rgba(255,255,255,0.08);
    }

    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,'Segoe UI',Roboto,Arial; -webkit-font-smoothing:antialiased}
    *,*:before,*:after{box-sizing:border-box}
    body{transition:background var(--transition-fast), color var(--transition-fast)}
    .glass{ background:var(--glass-bg); border:1px solid var(--glass-border); -webkit-backdrop-filter: blur(10px) saturate(120%); backdrop-filter: blur(10px) saturate(120%); box-shadow: var(--glass-shadow); color:var(--text); transition: background var(--transition-slow), border-color var(--transition-slow), box-shadow var(--transition-slow);}

    /* Viewport & content */
    .viewport{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;overflow:hidden;padding:calc(18px + env(safe-area-inset-top)) 6vw calc(var(--control-height) + 18px + env(safe-area-inset-bottom)) 6vw;z-index:1;touch-action:none}
    .frame{width:100%;max-width:1200px;height:100%;display:flex;align-items:flex-start;justify-content:center}
    .content{width:100%;max-width:980px;text-align:center;line-height:1.45;font-size:clamp(20px,4vw + 14px,64px);white-space:pre-wrap;hyphens:auto;padding-bottom:8vh;font-weight:900;transition:transform var(--transition-slow) linear, opacity 200ms linear;will-change:transform;overflow-wrap:break-word;word-break:break-word;-webkit-hyphens:auto;text-align-last:left;text-justify:inter-word;-webkit-user-select:none;user-select:none}
    .content.hidden{opacity:0}

    /* Toolbar: only Start, Pause (SVG), Settings */
    .toolbar{position:fixed;left:12px;right:12px;bottom:12px;z-index:120;height:var(--toolbar-height);min-height:48px;border-radius:12px;display:flex;align-items:center;gap:8px;padding:8px 12px;box-sizing:border-box}
    .toolbar.glass{background:var(--glass-bg);border:1px solid var(--glass-border);backdrop-filter:blur(8px);box-shadow:var(--glass-shadow)}
    .controls{display:flex;align-items:center;justify-content:space-between;width:100%}
    .left{display:flex;gap:8px;align-items:center}
    .right{display:flex;gap:8px;align-items:center}

    .btn{background:transparent;border:0;color:var(--text);width:var(--btn-size);height:var(--btn-size);padding:6px;border-radius:var(--btn-radius);cursor:pointer;font-size:18px;display:inline-flex;align-items:center;justify-content:center;transition:transform 120ms, background 120ms}
    .btn:active{transform:scale(0.98)}
    .btn.primary{background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04)}
    .btn.outline{border:1px solid var(--glass-border);background:transparent}
    .btn .icon{display:inline-block;font-size:18px;line-height:1}
    .open-panel-btn{min-width:110px;height:var(--btn-size);padding:8px 10px;font-weight:600;border-radius:10px;font-size:14px}

    /* Panel */
    .panel-wrap{position:fixed;left:8px;right:8px;bottom:calc(12px + var(--toolbar-height));z-index:150;display:block;pointer-events:none}
    .panel{width:100%;max-width:980px;margin:0 auto;border-radius:14px 14px 8px 8px;overflow:hidden;background:var(--glass-bg);border:1px solid var(--glass-border);box-shadow:0 30px 80px rgba(0,0,0,0.6);transform:translateY(110%);transition:transform var(--transition-fast) cubic-bezier(.2,.9,.2,1);pointer-events:auto;max-height:80vh;display:flex;flex-direction:column;-webkit-backdrop-filter: blur(10px) saturate(120%);backdrop-filter: blur(10px) saturate(120%);}
    .panel.open{transform:translateY(0)}
    .panel .handle{height:56px;display:flex;align-items:center;gap:10px;padding:8px 12px;border-bottom:1px solid rgba(255,255,255,0.02)}
    .panel .body{padding:12px;overflow:auto}

    /* Form layout: keep options in one row, as requested */
    .form-row{display:flex;gap:12px;align-items:center}
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    label{font-size:13px;color:var(--muted)}
    textarea#input{
      width:100%;min-height:140px;resize:vertical;padding:12px;border-radius:10px;border:1px solid var(--glass-border);background:linear-gradient(0deg, rgba(255,255,255,0.01), rgba(255,255,255,0.01));color:var(--text);outline:none;box-shadow:none;font-family:inherit;background-clip:padding-box;
    }

    /* Range styling with gray thumb */
    input[type=range]{-webkit-appearance:none;height:8px;background:transparent;width:100%}
    input[type=range]::-webkit-slider-runnable-track{height:8px;border-radius:999px;background:rgba(255,255,255,0.06);border:1px solid rgba(0,0,0,0.05)}
    input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;margin-top:-6px;width:20px;height:20px;border-radius:50%;background:var(--range-thumb-gray);border:2px solid var(--range-thumb-border-dark);box-shadow:0 4px 8px rgba(0,0,0,0.25)}
    :root[data-theme='light'] input[type=range]::-webkit-slider-thumb{border:2px solid var(--range-thumb-border-light)}
    input[type=range]:focus{outline:none}
    input[type=range]::-moz-range-track{height:8px;border-radius:999px;background:rgba(255,255,255,0.06)}
    input[type=range]::-moz-range-thumb{width:20px;height:20px;border-radius:50%;background:var(--range-thumb-gray);border:2px solid var(--range-thumb-border-dark)}
    @media (max-width:700px){ input[type=range]::-webkit-slider-thumb{width:24px;height:24px;margin-top:-8px} }

    /* Layout fixes for buttons in panel (no overlap) */
    .panel-actions{display:flex;gap:12px;justify-content:flex-end;margin-top:12px}
    .panel-actions .btn{min-width:92px}

    /* refined select + button styles */
    select{
      -webkit-appearance:none;
      appearance:none;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 10px;
      padding: 10px 14px;
      font-size: 14px;
      color: var(--text);
      cursor: pointer;
      transition: 180ms;
      backdrop-filter: blur(8px);
    }
    select:hover{ background: rgba(255,255,255,0.06); }
    select:focus{ outline: none; border-color: var(--accent); }

    .panel-actions .btn{
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.06);
      padding: 10px 12px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      min-width: 88px;
      transition: 160ms;
      height:44px;
    }
    .panel-actions .btn:hover{
      background: rgba(255,255,255,0.10);
      border-color: rgba(255,255,255,0.14);
    }
    .panel-actions .btn.primary{
      background: linear-gradient(180deg, rgba(255,255,255,0.14), rgba(255,255,255,0.06));
      border-color: rgba(255,255,255,0.22);
    }
    .panel-actions .btn.primary:hover{
      background: linear-gradient(180deg, rgba(255,255,255,0.22), rgba(255,255,255,0.12));
      border-color: rgba(255,255,255,0.36);
    }

    /* SPLASH ‚Äî frosted glass + emoji (adjusted) */
    .splash {
      position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;
      background: rgba(255,255,255,0.02);
      -webkit-backdrop-filter: blur(14px) saturate(120%);
      backdrop-filter: blur(14px) saturate(120%);
      opacity:0;pointer-events:none;transition:opacity 300ms ease;backface-visibility:hidden;
    }
    .splash.visible{opacity:1;pointer-events:auto}
    .splash-inner{display:flex;align-items:center;justify-content:center;flex-direction:column;gap:12px;transform:translateZ(0);}
    .splash-emoji{
      font-size:3.6rem;line-height:1;opacity:0;transform:scale(0.92);
      animation: splashEmojiAnim 3.6s cubic-bezier(.22,.9,.33,1) forwards;
      will-change:opacity, transform;
      text-shadow: 0 6px 30px rgba(0,0,0,0.45);
    }
    @keyframes splashEmojiAnim{
      0%{opacity:0; transform:scale(0.85);} 
      28%{opacity:1; transform:scale(1.06);} /* –±–æ–ª–µ–µ –≤—ã—Ä–∞–∂–µ–Ω–Ω–æ–µ –ø–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ */
      74%{opacity:1; transform:scale(1);} 
      100%{opacity:0; transform:scale(0.95);} 
    }
    .splash-caption{font-size:14px;color:var(--muted);opacity:0.9}
    body.splash-active *:not(.splash){pointer-events:none !important}
    @media (max-width:700px){ .splash-emoji{font-size:clamp(40px, 28vw, 120px);} }
    @media (prefers-reduced-motion: reduce){ .panel{transition:none} .content{transition:none} .splash-emoji{animation:none;opacity:1} }

    @media (max-width:700px){
      .panel{left:6px;right:6px;border-radius:12px}
      :root{ --btn-size:46px }
      .open-panel-btn{min-width:96px;padding:6px 8px;font-size:13px}
    }
  </style>
</head>
<body>

  <!-- Splash overlay -->
  <div id="splash" class="splash" aria-hidden="true">
    <div class="splash-inner">
      <div id="splashEmoji" class="splash-emoji" aria-hidden="true">‚ú®</div>
      <!-- <div class="splash-caption">–¢–µ–ª–µ—Å—É—Ñ–ª—ë—Ä</div> -->
    </div>
  </div>

  <!-- Toolbar: Start, Pause (SVG), Settings -->
  <div class="toolbar glass" id="toolbar" role="region" aria-label="–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è">
    <div class="controls">
      <div class="left">
        <button id="startBtn" class="btn primary" aria-label="–ó–∞–ø—É—Å—Ç–∏—Ç—å" title="–ó–∞–ø—É—Å—Ç–∏—Ç—å">
          <span class="icon" id="playIcon">‚ñ∂</span>
        </button>

        <button id="pauseBtn" class="btn outline" aria-label="–ü–∞—É–∑–∞" title="–ü–∞—É–∑–∞ / –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å">
          <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true" focusable="false" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
            <rect x="6" y="4" width="4" height="16" rx="1"></rect>
            <rect x="14" y="4" width="4" height="16" rx="1"></rect>
          </svg>
        </button>
      </div>

      <div class="right">
        <button id="openPanelBtn" class="open-panel-btn btn outline" aria-haspopup="dialog" aria-expanded="false" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      </div>
    </div>
  </div>

  <!-- Slide-up panel -->
  <div class="panel-wrap" id="panelWrap">
    <div class="panel glass" id="panel" role="dialog" aria-modal="false" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ–ª–µ—Å—É—Ñ–ª–µ—Ä–∞">
      <div class="handle">
        <div style="flex:1">
          <div class="title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
          <div style="font-size:12px;color:var(--muted)">–¢–µ–∫—Å—Ç, —Å–∫–æ—Ä–æ—Å—Ç—å, —Ä–∞–∑–º–µ—Ä, —Ç–µ–º–∞, —à—Ä–∏—Ñ—Ç –∏ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ</div>
        </div>
        <div>
          <button id="closePanelBtn" class="btn" aria-label="–ó–∞–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å">‚úï</button>
        </div>
      </div>

      <div class="body">
        <div class="field">
          <label for="input">–¢–µ–∫—Å—Ç</label>
          <textarea id="input" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç —Å—é–¥–∞"></textarea>
        </div>

        <div class="field">
          <label for="speed">–°–∫–æ—Ä–æ—Å—Ç—å (px/—Å)</label>
          <input id="speed" type="range" min="10" max="300" value="40" />
        </div>

        <div class="field">
          <label for="size">–†–∞–∑–º–µ—Ä (px)</label>
          <input id="size" type="range" min="18" max="120" value="48" />
        </div>

        <!-- Single-row options -->
        <div class="form-row" style="margin-top:6px;">
          <div style="display:flex;flex-direction:column;gap:6px;">
            <label for="alignSelect">–í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ</label>
            <select id="alignSelect" class="align-select" aria-label="–í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞">
              <option value="left">–°–ª–µ–≤–∞</option>
              <option value="center">–ü–æ —Ü–µ–Ω—Ç—Ä—É</option>
              <option value="right">–°–ø—Ä–∞–≤–∞</option>
              <option value="justify">–ü–æ —à–∏—Ä–∏–Ω–µ</option>
            </select>
          </div>

          <div style="display:flex;flex-direction:column;gap:6px;">
            <label for="uppercaseToggle">–†–µ–∂–∏–º</label>
            <select id="uppercaseToggle" title="–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞">
              <option value="none">–û–±—ã—á–Ω—ã–π</option>
              <option value="uppercase">–í—Å–µ –ó–ê–ì–õ–ê–í–ù–´–ï</option>
            </select>
          </div>

          <div style="display:flex;flex-direction:column;gap:6px;">
            <label for="theme">–¢–µ–º–∞</label>
            <select id="theme" title="–¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è">
              <option value="dark">–¢—ë–º–Ω–∞—è</option>
              <option value="light">–°–≤–µ—Ç–ª–∞—è</option>
              <option value="sepia">–°–µ–ø–∏—è</option>
              <option value="navy">Navy</option>
              <option value="contrast">–í—ã—Å–æ–∫–∞—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–æ—Å—Ç—å</option>
            </select>
          </div>

          <div style="display:flex;flex-direction:column;gap:6px;">
            <label for="fontSelect">–®—Ä–∏—Ñ—Ç</label>
            <select id="fontSelect" title="–í—ã–±–æ—Ä —à—Ä–∏—Ñ—Ç–∞">
              <option value="Nunito">Nunito (Black)</option>
              <option value="Manrope">Manrope</option>
              <option value="Inter">Inter</option>
            </select>
          </div>
        </div>

        <div class="panel-actions">
          <button id="panelStartBtn" class="btn primary">–ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
          <button id="panelCloseAction" class="btn">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Elements
    const toolbar = document.getElementById('toolbar');
    const panel = document.getElementById('panel');
    const openPanelBtn = document.getElementById('openPanelBtn');
    const closePanelBtn = document.getElementById('closePanelBtn');
    const panelStartBtn = document.getElementById('panelStartBtn');
    const panelCloseAction = document.getElementById('panelCloseAction');
    const startBtn = document.getElementById('startBtn');
    const pauseBtn = document.getElementById('pauseBtn');

    // Panel controls
    const input = document.getElementById('input');
    const content = document.getElementById('content');
    const speedRange = document.getElementById('speed');
    const sizeRange = document.getElementById('size');
    const themeSelect = document.getElementById('theme');
    const fontSelect = document.getElementById('fontSelect');
    const alignSelect = document.getElementById('alignSelect');
    const uppercaseToggle = document.getElementById('uppercaseToggle');

    // State
    let rafId = null;
    let running = false;
    let paused = false;
    let finished = false;
    let manualMode = false;
    let startY = 0;
    let endY = 0;
    let currentY = 0;
    let lastTimestamp = null;

    const clamp = (v,a,b) => Math.max(a, Math.min(b, v));

    // ResizeObserver to set control heights (safe area handling)
    function setControlHeight(h){ document.documentElement.style.setProperty('--control-height', Math.ceil(h) + 'px'); }
    const roToolbar = new ResizeObserver(entries=>{
      const h = entries[0].contentRect.height || 64;
      document.documentElement.style.setProperty('--toolbar-height', Math.ceil(h) + 'px');
      if(!panel.classList.contains('open')) setControlHeight(h);
    });
    roToolbar.observe(toolbar);
    const roPanel = new ResizeObserver(entries=>{
      const h = entries[0].contentRect.height || 0;
      document.documentElement.style.setProperty('--panel-height', Math.ceil(h) + 'px');
      if(panel.classList.contains('open')) setControlHeight(h + 12);
    });
    roPanel.observe(panel);

    // Panel open/close
    function openPanel(){ panel.classList.add('open'); openPanelBtn.setAttribute('aria-expanded','true'); setTimeout(()=>{ setControlHeight(panel.getBoundingClientRect().height + 12); }, 80); }
    function closePanel(){ panel.classList.remove('open'); openPanelBtn.setAttribute('aria-expanded','false'); setTimeout(()=>{ setControlHeight(toolbar.getBoundingClientRect().height || 64); }, 80); }
    openPanelBtn.addEventListener('click', ()=> panel.classList.contains('open') ? closePanel() : openPanel());
    closePanelBtn.addEventListener('click', closePanel);
    panelCloseAction.addEventListener('click', closePanel);

    // Apply theme/font/alignment/uppercase
    function applyTheme(theme){ document.documentElement.setAttribute('data-theme', theme); sessionStorage.setItem('teleprompter_theme', theme); themeSelect.value = theme; }
    function applyFont(font){ const map = { Nunito: "'Nunito', sans-serif", Manrope: "'Manrope', sans-serif", Inter: "'Inter', sans-serif" }; const weightMap = { Nunito:'900', Manrope:'700', Inter:'700' }; content.style.fontFamily = map[font] || map.Nunito; content.style.fontWeight = weightMap[font] || '700'; sessionStorage.setItem('teleprompter_font', font); fontSelect.value = font; }
    function applyAlignment(a){ if(a === 'justify') content.style.textAlign = 'justify'; else content.style.textAlign = a; alignSelect.value = a; sessionStorage.setItem('teleprompter_align', a); requestAnimationFrame(()=>adjustJustifyHeuristic()); }
    function applyUppercase(mode){ content.style.textTransform = (mode === 'uppercase') ? 'uppercase' : 'none'; uppercaseToggle.value = mode; sessionStorage.setItem('teleprompter_case', mode); }

    themeSelect.addEventListener('change', e=> applyTheme(e.target.value));
    fontSelect.addEventListener('change', e=> applyFont(e.target.value));
    alignSelect.addEventListener('change', e=> applyAlignment(e.target.value));
    uppercaseToggle.addEventListener('change', e=> applyUppercase(e.target.value));

    // Render content
    function renderContent(){
      let txt = input.value || '';
      const mode = sessionStorage.getItem('teleprompter_case') || uppercaseToggle.value || 'none';
      if(mode === 'uppercase') txt = txt.toUpperCase();
      content.textContent = txt;
      const size = Math.max(12, Math.min(120, Number(sizeRange.value)||48));
      content.style.fontSize = size + 'px';
      content.classList.toggle('hidden', !content.textContent);
      recalcSizes();
    }
    input.addEventListener('input', renderContent);
    sizeRange.addEventListener('input', renderContent);
    speedRange.addEventListener('input', ()=> recalcSizes());

    function recalcSizes(){
      const vh = document.getElementById('viewport').clientHeight || window.innerHeight;
      const ch = content.scrollHeight || 0;
      startY = vh + 24;
      endY = -ch - 24;
      if(!running && !paused){
        const centerY = Math.round((vh - content.clientHeight) / 2);
        currentY = centerY;
        content.style.transform = `translateY(${currentY}px)`;
      } else {
        currentY = clamp(currentY, endY, startY);
        content.style.transform = `translateY(${currentY}px)`;
      }
    }

    // Heuristic for justify
    function adjustJustifyHeuristic(){
      if(content.style.textAlign !== 'justify') return;
      const cw = content.clientWidth || 1;
      const fs = parseFloat(getComputedStyle(content).fontSize) || 16;
      const avgCharsPerLine = cw / (fs * 0.56);
      const lineCount = Math.max(1, Math.round(content.scrollHeight / (fs * 1.45)));
      if(avgCharsPerLine < 25 || lineCount < 3) content.style.textAlign = 'left';
      else content.style.textAlign = 'justify';
    }

    // Scrolling
    function startScroll(){
      renderContent();
      recalcSizes();
      if(!content.textContent) return;
      if(!paused) currentY = startY;
      running = true; paused = false; finished = false; lastTimestamp = null;
      closePanel();
      disableManualHandlers();
      function step(ts){
        if(!running) return;
        if(lastTimestamp === null) lastTimestamp = ts;
        const dt = (ts - lastTimestamp) / 1000;
        lastTimestamp = ts;
        const speed = Number(speedRange.value) || 40;
        currentY -= speed * dt;
        content.style.transform = `translateY(${currentY}px)`;
        if(currentY <= endY){
          running = false; paused = true; finished = true; currentY = endY; content.style.transform = `translateY(${currentY}px)`;
          if(rafId) cancelAnimationFrame(rafId);
          rafId = null;
          smoothReturnToCenter(800);
          return;
        }
        rafId = requestAnimationFrame(step);
      }
      if(rafId) cancelAnimationFrame(rafId);
      rafId = requestAnimationFrame(step);
    }

    function pauseScroll(){
      if(!running) return;
      running = false; paused = true;
      if(rafId) cancelAnimationFrame(rafId); rafId = null;
    }

    function smoothReturnToCenter(duration = 800){
      const vh = document.getElementById('viewport').clientHeight || window.innerHeight;
      const centerY = Math.round((vh - content.clientHeight) / 2);
      const from = currentY; const to = clamp(centerY, endY, startY);
      const start = performance.now();
      function anim(t){
        const p = Math.min(1, (t - start) / duration);
        const ease = 1 - Math.pow(1 - p, 3);
        currentY = from + (to - from) * ease;
        content.style.transform = `translateY(${currentY}px)`;
        if(p < 1) requestAnimationFrame(anim);
        else { currentY = to; content.style.transform = `translateY(${currentY}px)`; enableManualHandlers(); }
      }
      requestAnimationFrame(anim);
    }

    // Manual handlers (only after finish)
    function enableManualHandlers(){
      if(manualMode) return;
      manualMode = true;
      window.addEventListener('wheel', manualWheel, {passive:false});
      window.addEventListener('touchstart', onTouchStart, {passive:false});
      window.addEventListener('touchmove', onTouchMove, {passive:false});
      window.addEventListener('touchend', onTouchEnd, {passive:false});
    }
    function disableManualHandlers(){
      if(!manualMode) return;
      manualMode = false;
      window.removeEventListener('wheel', manualWheel);
      window.removeEventListener('touchstart', onTouchStart);
      window.removeEventListener('touchmove', onTouchMove);
      window.removeEventListener('touchend', onTouchEnd);
    }
    function manualWheel(e){ if(!manualMode) return; e.preventDefault(); currentY -= e.deltaY; currentY = clamp(currentY, endY, startY); content.style.transform = `translateY(${currentY}px)`; }
    let tsY = 0;
    function onTouchStart(e){ if(!manualMode) return; tsY = e.touches[0].clientY; }
    function onTouchMove(e){ if(!manualMode) return; const y = e.touches[0].clientY; const dy = y - tsY; tsY = y; currentY += dy; currentY = clamp(currentY, endY, startY); content.style.transform = `translateY(${currentY}px)`; e.preventDefault(); }
    function onTouchEnd(e){ /* noop */ }

    // Button bindings
    startBtn.addEventListener('click', ()=>{ if(!running) startScroll(); });
    panelStartBtn.addEventListener('click', ()=> startScroll());

    pauseBtn.addEventListener('click', ()=>{
      if(running) pauseScroll();
      else if(paused && !finished) startScroll();
      else startScroll();
    });

    // Tap on content toggles pause/start
    content.addEventListener('click', ()=>{
      if(running) pauseScroll();
      else if(paused && !finished) startScroll();
      else startScroll();
    });

    // Keyboard shortcuts
    window.addEventListener('keydown', e=>{
      if(e.code === 'Space'){ e.preventDefault(); if(running) pauseScroll(); else if(paused && !finished) startScroll(); else startScroll(); }
      if(e.key === 'Escape'){ if(panel.classList.contains('open')) closePanel(); }
    });

    // Resize handling
    let resizeTimer = null;
    window.addEventListener('resize', ()=>{ clearTimeout(resizeTimer); resizeTimer = setTimeout(()=>{ renderContent(); recalcSizes(); setControlHeight(toolbar.getBoundingClientRect().height || 64); }, 120); });

    // Init saved settings
    window.addEventListener('load', ()=>{
      const savedTheme = sessionStorage.getItem('teleprompter_theme') || 'dark';
      const savedFont = sessionStorage.getItem('teleprompter_font') || 'Nunito';
      const savedAlign = sessionStorage.getItem('teleprompter_align') || 'center';
      const savedCase = sessionStorage.getItem('teleprompter_case') || 'none';
      applyTheme(savedTheme);
      applyFont(savedFont);
      applyAlignment(savedAlign);
      applyUppercase(savedCase);
      renderContent();
      if(window.innerWidth <= 700) closePanel();
      setTimeout(()=> setControlHeight(toolbar.getBoundingClientRect().height || 64), 80);

      // Trigger splash animation on load
      startSplashIntro({ duration: 2200 });
    });

    // Prevent accidental selection when interacting with controls
    ['mousedown','touchstart'].forEach(ev=> {
      document.querySelectorAll('.btn, input, select, textarea').forEach(el => {
        el.addEventListener(ev, (e)=> e.stopPropagation());
      });
    });

    /* ===== Splash intro logic ===== */
    function startSplashIntro({ duration = 5000 } = {}){
      const splash = document.getElementById('splash');
      const splashEmoji = document.getElementById('splashEmoji');
      const emojis = ['üéÑ','üçä','üå≤','ü¶å','üéÖüèª','ü§∂üèª','‚òÉÔ∏è','‚ùÑÔ∏è','üéÅ','‚ú®','ü§ç','üå®','ü™Ω','ü™µ','üç∂','ü•ß','üåå','üéä','üí≠','üßùüèª','üß≠','ü©∂'];

      const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

      // Choose random emoji
      const idx = Math.floor(Math.random() * emojis.length);
      const chosen = emojis[idx];
      splashEmoji.textContent = chosen;

      // Activate overlay
      document.body.classList.add('splash-active');
      splash.classList.add('visible');
      splash.setAttribute('aria-hidden', 'false');

      if(prefersReduced){
        splashEmoji.style.opacity = '1';
        setTimeout(cleanupSplash, Math.min(duration, 2800));
        return;
      }

      let done = false;
      function cleanupSplash(){
        if(done) return; done = true;
        // fade overlay out
        splash.classList.remove('visible');
        // allow CSS opacity transition (300ms) then remove
        setTimeout(()=>{
          splash.setAttribute('aria-hidden', 'true');
          if(splash.parentNode) splash.parentNode.removeChild(splash);
          document.body.classList.remove('splash-active');
        }, 340);
      }

      // Use animationend on the emoji element
      const handleAnimEnd = (e)=>{
        cleanupSplash();
      };
      splashEmoji.addEventListener('animationend', handleAnimEnd, { once: true });

      // Safety timeout in case animationend doesn't fire
      setTimeout(cleanupSplash, duration + 420);
    }
    /* ===== End splash logic ===== */
  </script>
</body>
</html>
