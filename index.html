<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Телесуфлёр — панель управления (редизайн)</title>
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@900&family=Inter:wght@700;900&family=Manrope:wght@700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0f1113;
      --text:#dfefff;
      --accent:#6fb3ff;
      --muted:rgba(255,255,255,0.58);
      --control-height:72px; /* dynamic: toolbar or panel height */
      --toolbar-height:64px;
      --panel-height:0px;
    }

    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,'Segoe UI',Roboto,Arial; -webkit-font-smoothing:antialiased}
    *,*:before,*:after{box-sizing:border-box}

    /* Teleprompter viewport: top/bottom padding uses --control-height to avoid overlap */
    .viewport{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;overflow:hidden;padding:calc(20px + env(safe-area-inset-top)) 6vw calc(var(--control-height) + 20px + env(safe-area-inset-bottom)) 6vw;z-index:1}
    .frame{width:100%;max-width:1200px;height:100%;display:flex;align-items:flex-start;justify-content:center}
    .content{width:100%;max-width:980px;text-align:center;line-height:1.45;font-size:clamp(20px,4vw + 14px,64px);white-space:pre-wrap;hyphens:auto;padding-bottom:8vh;font-weight:900;transition:transform 120ms linear}
    .content.hidden{opacity:0}

    /* Bottom toolbar (primary controls) — minimal and compact */
    .toolbar{
      position:fixed;left:12px;right:12px;bottom:12px;z-index:120;height:var(--toolbar-height);min-height:48px;border-radius:12px;display:flex;align-items:center;gap:8px;padding:8px 10px;background:rgba(255,255,255,0.04);backdrop-filter:blur(6px);box-shadow:0 8px 28px rgba(0,0,0,0.35);
    }
    .toolbar .left{display:flex;gap:8px;align-items:center}
    .toolbar .right{margin-left:auto;display:flex;gap:8px;align-items:center}
    .btn{background:transparent;border:0;color:var(--text);padding:8px;border-radius:10px;cursor:pointer;font-size:15px}
    .btn.primary{background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,0.06)}
    .icon{width:36px;height:36px;display:inline-flex;align-items:center;justify-content:center;border-radius:8px}

    /* Floating action: open panel */
    .open-panel-btn{padding:10px 12px;font-weight:700}

    /* Slide-up settings panel (advanced controls). Hidden by default; slides from bottom. */
    .panel-wrap{position:fixed;left:8px;right:8px;bottom:calc(12px + var(--toolbar-height));z-index:150;display:block;pointer-events:none}
    .panel{
      width:100%;max-width:980px;margin:0 auto;border-radius:14px 14px 8px 8px;overflow:hidden;background:rgba(18,20,24,0.96);border:1px solid rgba(255,255,255,0.04);box-shadow:0 30px 80px rgba(0,0,0,0.6);transform:translateY(110%);transition:transform 320ms cubic-bezier(.2,.9,.2,1);pointer-events:auto;max-height:80vh;display:flex;flex-direction:column
    }
    .panel.open{transform:translateY(0)}
    .panel .handle{height:44px;display:flex;align-items:center;gap:10px;padding:8px 12px;border-bottom:1px solid rgba(255,255,255,0.02)}
    .panel .handle .title{font-weight:700}
    .panel .body{padding:12px;overflow:auto}

    /* Controls layout inside panel */
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    .row{display:flex;gap:8px;align-items:center}
    textarea#input{width:100%;min-height:120px;resize:vertical;padding:10px;border-radius:10px;border:0;background:rgba(255,255,255,0.02);color:var(--text);outline:1px solid rgba(255,255,255,0.03)}
    label{font-size:13px;color:var(--muted)}
    input[type=range]{-webkit-appearance:none;height:28px;background:transparent}
    select{background:transparent;border-radius:8px;padding:8px;border:1px solid rgba(255,255,255,0.03);color:var(--text)}

    /* Accessibility and responsive tweaks */
    @media (max-width:700px){
      .panel{left:6px;right:6px;border-radius:12px}
      .toolbar{left:10px;right:10px;padding:6px 8px}
      .icon{width:36px;height:36px}
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){ .panel{transition:none} }
  </style>
</head>
<body>

  <div class="viewport" id="viewport">
    <div class="frame">
      <div id="content" class="content" tabindex="-1" aria-live="polite">Вставьте текст или нажмите кнопку настроек внизу, чтобы вписать текст и параметры.</div>
    </div>
  </div>

  <!-- Bottom toolbar: always visible, compact -->
  <div class="toolbar" id="toolbar" role="region" aria-label="Панель управления">
    <div class="left">
      <button id="startBtn" class="btn primary" aria-label="Запустить"><span class="icon">▶</span></button>
      <button id="pauseBtn" class="btn" aria-label="Пауза"><span class="icon">⏸</span></button>
      <button id="centerBtn" class="btn" aria-label="Центр">Центр</button>
    </div>
    <div class="right">
      <button id="fsBtn" class="btn" aria-label="Полный экран">⤢</button>
      <button id="openPanelBtn" class="btn open-panel-btn" aria-haspopup="dialog" aria-expanded="false">Настройки</button>
    </div>
  </div>

  <!-- Slide-up panel with advanced controls -->
  <div class="panel-wrap" id="panelWrap">
    <div class="panel" id="panel" role="dialog" aria-modal="false" aria-label="Настройки телесуфлера">
      <div class="handle">
        <div style="flex:1">
          <div class="title">Настройки</div>
          <div style="font-size:12px;color:var(--muted)">Ввод текста, скорость, размер, тема и шрифт</div>
        </div>
        <div>
          <button id="closePanelBtn" class="btn" aria-label="Закрыть панель">✕</button>
        </div>
      </div>
      <div class="body">
        <div class="field">
          <label for="input">Текст</label>
          <textarea id="input" placeholder="Вставьте текст сюда"></textarea>
        </div>

        <div class="row field">
          <div style="flex:1">
            <label for="speed">Скорость (px/с)</label>
            <input id="speed" type="range" min="10" max="300" value="40" />
          </div>
          <div style="width:120px">
            <label for="size">Размер (px)</label>
            <input id="size" type="range" min="18" max="120" value="48" />
          </div>
        </div>

        <div class="row field">
          <div style="flex:1">
            <label for="theme">Тема</label>
            <select id="theme" title="Тема оформления">
              <option value="dark">Тёмная</option>
              <option value="light">Светлая</option>
              <option value="sepia">Сепия</option>
              <option value="navy">Navy</option>
              <option value="contrast">Высокая контрастность</option>
            </select>
          </div>
          <div style="width:160px">
            <label for="fontSelect">Шрифт</label>
            <select id="fontSelect" title="Выбор шрифта">
              <option value="Nunito">Nunito (Black)</option>
              <option value="Manrope">Manrope</option>
              <option value="Inter">Inter</option>
            </select>
          </div>
        </div>

        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px">
          <button id="panelStartBtn" class="btn primary">Запустить</button>
          <button id="panelCloseAction" class="btn">Закрыть</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Restore button (appears when fullscreen & hidden UI) -->
  <button id="restoreBtn" class="btn" style="position:fixed;left:50%;transform:translateX(-50%);bottom:calc(var(--control-height) + 26px);z-index:200;display:none">Закончить — показать интерфейс</button>

  <script>
    // Elements
    const toolbar = document.getElementById('toolbar');
    const panel = document.getElementById('panel');
    const panelWrap = document.getElementById('panelWrap');
    const openPanelBtn = document.getElementById('openPanelBtn');
    const closePanelBtn = document.getElementById('closePanelBtn');
    const panelStartBtn = document.getElementById('panelStartBtn');
    const panelCloseAction = document.getElementById('panelCloseAction');
    const startBtn = document.getElementById('startBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const fsBtn = document.getElementById('fsBtn');
    const restoreBtn = document.getElementById('restoreBtn');

    // Teleprompter controls inside panel
    const input = document.getElementById('input');
    const content = document.getElementById('content');
    const speedRange = document.getElementById('speed');
    const sizeRange = document.getElementById('size');
    const themeSelect = document.getElementById('theme');
    const fontSelect = document.getElementById('fontSelect');

    // Scrolling state (reused logic simplified)
    let rafId = null, startTime = 0, startY = 0, endY = 0, currentY = 0, running=false, paused=false, lastSpeed=Number(speedRange.value)||40;

    // Update CSS vars for control heights using ResizeObserver — ensures viewport padding is correct
    function setControlHeight(h){ document.documentElement.style.setProperty('--control-height', Math.ceil(h) + 'px'); }
    // observe toolbar and panel height: when panel open -> panel height + toolbar gap; else toolbar height
    const roToolbar = new ResizeObserver(entries=>{
      const h = entries[0].contentRect.height || 64;
      document.documentElement.style.setProperty('--toolbar-height', Math.ceil(h) + 'px');
      // if panel closed use toolbar as control height
      if(!panel.classList.contains('open')) setControlHeight(h);
    });
    roToolbar.observe(toolbar);

    const roPanel = new ResizeObserver(entries=>{
      const h = entries[0].contentRect.height || 0;
      document.documentElement.style.setProperty('--panel-height', Math.ceil(h) + 'px');
      // if panel is open, use panel height + toolbar overlap area (we position panel above toolbar)
      if(panel.classList.contains('open')){
        // add small gap
        setControlHeight(h + 12);
      }
    });
    roPanel.observe(panel);

    // Panel open/close helpers
    function openPanel(){ panel.classList.add('open'); openPanelBtn.setAttribute('aria-expanded','true'); /* use panel height as control */ const h = panel.getBoundingClientRect().height || 0; setControlHeight(h + 12); }
    function closePanel(){ panel.classList.remove('open'); openPanelBtn.setAttribute('aria-expanded','false'); const th = toolbar.getBoundingClientRect().height || 64; setControlHeight(th); }

    openPanelBtn.addEventListener('click', ()=>{ if(panel.classList.contains('open')) closePanel(); else openPanel(); });
    closePanelBtn.addEventListener('click', closePanel);
    panelCloseAction.addEventListener('click', closePanel);

    // Apply theme & font
    function applyTheme(theme){
      document.documentElement.setAttribute('data-theme', theme);
      sessionStorage.setItem('teleprompter_theme', theme);
    }
    function applyFont(font){
      const map = { Nunito: "'Nunito', sans-serif", Manrope: "'Manrope', sans-serif", Inter: "'Inter', sans-serif" };
      const weightMap = { Nunito: '900', Manrope: '700', Inter: '700' };
      content.style.fontFamily = map[font] || map.Nunito;
      content.style.fontWeight = weightMap[font] || '700';
      sessionStorage.setItem('teleprompter_font', font);
    }

    themeSelect.addEventListener('change', e=> applyTheme(e.target.value));
    fontSelect.addEventListener('change', e=> applyFont(e.target.value));

    // Render content
    function renderContent(){ content.textContent = input.value || ''; const size = Math.max(12, Math.min(120, Number(sizeRange.value)||48)); content.style.fontSize = size + 'px'; content.classList.toggle('hidden', !content.textContent); recalcSizes(); }
    input.addEventListener('input', renderContent);
    sizeRange.addEventListener('input', renderContent);

    function recalcSizes(){ const vh = document.getElementById('viewport').clientHeight; const ch = content.scrollHeight || 0; startY = vh + 24; endY = -ch - 24; }

    // Scrolling logic (kept simple)
    function startScroll(){ cancelAnimationFrame(rafId); renderContent(); recalcSizes(); if(!content.textContent) return; const speed = Number(speedRange.value)||40; lastSpeed = speed; running=true; paused=false; startTime = performance.now(); currentY = startY; content.style.transform = `translateY(${startY}px)`; function step(ts){ if(!running || paused) return; const elapsed = ts - startTime; const delta = (elapsed/1000)*speed; const newY = startY - delta; currentY = newY; content.style.transform = `translateY(${newY}px)`; if(newY <= endY){ running=false; paused=true; cancelAnimationFrame(rafId); return; } rafId = requestAnimationFrame(step); } rafId = requestAnimationFrame(step); }
    function pauseScroll(){ if(!running) return; paused=true; running=false; cancelAnimationFrame(rafId); }

    // Button bindings (toolbar + panel)
    startBtn.addEventListener('click', ()=>{ closePanel(); startScroll(); });
    panelStartBtn.addEventListener('click', ()=>{ openPanelBtn.setAttribute('aria-expanded','false'); closePanel(); startScroll(); });
    pauseBtn.addEventListener('click', ()=>{ if(running) pauseScroll(); else if(paused) startScroll(); });

    // Fullscreen toggle
    fsBtn.addEventListener('click', async ()=>{
      try{
        if(!document.fullscreenElement){ await document.documentElement.requestFullscreen(); restoreBtn.style.display = 'block'; }
        else{ if(document.exitFullscreen) await document.exitFullscreen(); restoreBtn.style.display = 'none'; }
      }catch(e){}
    });

    restoreBtn.addEventListener('click', ()=>{ if(document.fullscreenElement && document.exitFullscreen) document.exitFullscreen(); restoreBtn.style.display = 'none'; closePanel(); });

    // Init
    window.addEventListener('load', ()=>{
      renderContent();
      const savedTheme = sessionStorage.getItem('teleprompter_theme') || 'dark';
      const savedFont = sessionStorage.getItem('teleprompter_font') || 'Nunito';
      applyTheme(savedTheme); applyFont(savedFont);
      // on small screens, start collapsed (panel closed) but toolbar visible
      if(window.innerWidth <= 700){ closePanel(); }
      // set initial control height from toolbar
      const th = toolbar.getBoundingClientRect().height || 64; setControlHeight(th);
    });

    // Keep content accessible: click center to toggle pause
    content.addEventListener('click', ()=>{ if(running) pauseScroll(); else if(paused) startScroll(); });

    // Accessibility keyboard shortcuts
    window.addEventListener('keydown', e=>{
      if(e.code === 'Space'){ e.preventDefault(); if(running) pauseScroll(); else if(paused) startScroll(); else startScroll(); }
      if(e.key.toLowerCase()==='f'){ e.preventDefault(); if(!document.fullscreenElement && document.documentElement.requestFullscreen) document.documentElement.requestFullscreen(); else if(document.exitFullscreen) document.exitFullscreen(); }
      if(e.key === 'Escape'){ if(panel.classList.contains('open')) closePanel(); if(document.fullscreenElement && document.exitFullscreen) document.exitFullscreen(); }
    });

    // Ensure content and control heights recalc on orientation/resize
    window.addEventListener('resize', ()=>{ setTimeout(()=>{ recalcSizes(); const th = toolbar.getBoundingClientRect().height || 64; if(!panel.classList.contains('open')) setControlHeight(th); else setControlHeight(panel.getBoundingClientRect().height + 12); }, 120); });
  </script>
</body>
</html>
